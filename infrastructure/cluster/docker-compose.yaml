version: "3.9"

x-healthcheck: &default-healthcheck
  test: ["CMD-SHELL", "pgrep -f sshd >/dev/null && tmux -V >/dev/null"]
  interval: 10s
  timeout: 3s
  retries: 5
  start_period: 5s

services:
  node1:
    build: ./node
    container_name: node1
    hostname: node1
    ports:
      - "2221:22"
    networks:
      - cluster-net
    volumes:
      - ../data:/neurocore/data
      - ../logs:/neurocore/logs
      - ../../config:/config:ro
    environment:
      - FAKE_GPU_COUNT=2
      - FAKE_SEED=42
      - CONFIG_NODES_PATH=/config/nodes.yaml
      - CONFIG_GPU_INVENTORY_PATH=/config/gpu_inventory.yaml
    healthcheck: *default-healthcheck
    restart: unless-stopped

  node2:
    build: ./node
    container_name: node2
    hostname: node2
    ports:
      - "2222:22"
    networks:
      - cluster-net
    volumes:
      - ../data:/neurocore/data
      - ../logs:/neurocore/logs
      - ../../config:/config:ro
    environment:
      - FAKE_GPU_COUNT=1
      - FAKE_SEED=42
      - CONFIG_NODES_PATH=/config/nodes.yaml
      - CONFIG_GPU_INVENTORY_PATH=/config/gpu_inventory.yaml
    healthcheck: *default-healthcheck
    restart: unless-stopped

  node3:
    build: ./node
    container_name: node3
    hostname: node3
    ports:
      - "2223:22"
    networks:
      - cluster-net
    volumes:
      - ../data:/neurocore/data
      - ../logs:/neurocore/logs
      - ../../config:/config:ro
    environment:
      - FAKE_GPU_COUNT=1
      - FAKE_SEED=42
      - CONFIG_NODES_PATH=/config/nodes.yaml
      - CONFIG_GPU_INVENTORY_PATH=/config/gpu_inventory.yaml
    healthcheck: *default-healthcheck
    restart: unless-stopped

  observer:
    build: ./observer
    volumes:
      - ../data:/neurocore/data
      - ../logs:/neurocore/logs
      - ../../config:/config:ro
    environment:
      - CONFIG_NODES_PATH=/config/nodes.yaml
      - CONFIG_GPU_INVENTORY_PATH=/config/gpu_inventory.yaml
    command: >
      bash -c "while true; do
        python3 /opt/neurocore/discover_jobs.py &&
        python3 /opt/neurocore/poll_metrics.py;
        echo 'Observer polled, sleeping 5...';
        sleep 5;
      done"
    depends_on:
      - node1
      - node2
      - node3
      
    networks:
      - cluster-net

  dashboard:
    # This is a Debian-based image and is much more compatible
    # with native packages like lightningcss.
    image: node:20-slim
    # â„¹ï¸ Set the container's working directory
    working_dir: /app
    # ğŸ—ºï¸ Mount volumes
    volumes:
      # 1. Mount your local Dashboard code (same as before)
      - ../../Dashboard:/app
      # 2. Mount the shared data folder (same as before)
      - ../data:/data-bridge
      # separate and isolated inside the container."
      # This prevents conflicts between Mac and Linux binaries.
      - /app/node_modules
    # ğŸ”Œ Expose your Next.js port (3000) to your Mac
    ports:
      - "3000:3000"
    # ğŸ§  Set the environment variable (same as before)
    environment:
      - DATA_PATH=/data-bridge
    # ğŸš€ The command to start the Next.js dev server (same as before)
    command: ["sh", "-c", "npm install && npm run dev"]
    # ğŸ”— Connect to the same network (same as before)
    networks:
      - cluster-net

networks:
  cluster-net:
    name: cluster-net
