x-healthcheck: &default-healthcheck
  test: ["CMD-SHELL", "pgrep -f sshd >/dev/null && tmux -V >/dev/null"]
  interval: 10s
  timeout: 3s
  retries: 5
  start_period: 5s

services:
  node1:
    build:
      context: ./node
      dockerfile: Dockerfile
    image: genai-node:latest
    container_name: node1
    hostname: core-alpha
    ports:
      - "2221:22"
    environment:
      - FAKE_GPU_COUNT=2
      - FAKE_SEED=42
      - FAKE_GPU_MEM_TOTAL=16384
    networks:
      - cluster-net
    volumes:
      - ../../data:/neurocore/data
      - ../../logs:/neurocore/logs
    healthcheck: *default-healthcheck
    restart: unless-stopped

  node2:
    image: genai-node:latest
    container_name: node2
    hostname: neuron-beta
    ports:
      - "2222:22"
    environment:
      - FAKE_GPU_COUNT=1
      - FAKE_SEED=42
      - FAKE_GPU_MEM_TOTAL=12288
    networks:
      - cluster-net
    volumes:
      - ../../data:/neurocore/data
      - ../../logs:/neurocore/logs
    healthcheck: *default-healthcheck
    restart: unless-stopped

  node3:
    image: genai-node:latest
    container_name: node3
    hostname: synapse-gamma
    ports:
      - "2223:22"
    environment:
      - FAKE_GPU_COUNT=1
      - FAKE_SEED=42
      - FAKE_GPU_MEM_TOTAL=8192
    networks:
      - cluster-net
    volumes:
      - ../../data:/neurocore/data
      - ../../logs:/neurocore/logs
    healthcheck: *default-healthcheck
    restart: unless-stopped

  observer:
    build:
      context: ./observer
      dockerfile: Dockerfile
    container_name: cluster-observer-1
    networks:
      - cluster-net
    volumes:
      - ../../data:/neurocore/data
      - ../../logs:/neurocore/logs
      - ../../config:/opt/neurocore/config
    command: >
      bash -c "python3 /opt/neurocore/poll_metrics.py --config /opt/neurocore/config/nodes.yaml --output /neurocore/data/metrics.jsonl & while true; do python3 /opt/neurocore/build_snapshot.py --metrics /neurocore/data/metrics.jsonl --nodes /opt/neurocore/config/nodes.yaml --gpu-inventory /opt/neurocore/config/gpu_inventory.yaml --out /neurocore/data/cluster_snapshot.json; echo 'Observer polled (Task 2.3 snapshot), sleeping 10...'; sleep 10; done"
    user: root
    depends_on:
      - node1
      - node2
      - node3
    restart: unless-stopped

networks:
  cluster-net:
    external: true
    name: cluster-net